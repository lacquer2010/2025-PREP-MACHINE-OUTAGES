<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Outage Planner v3.5 ‚Äî single‚Äëfile build</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#111722; --muted:#7b8aa1; --text:#e6eefc; --accent:#6aa8ff; --green:#23c483; --red:#ff6b6b; --amber:#ffc857;
      --ring:#2b3a55; --outline:#1d2636; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0f14,#0b0f14 40%,#0e1420);color:var(--text);font:15px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}

    /* App chrome */
    .app{max-width:1100px;margin:24px auto;padding:0 16px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;background:var(--card);border:1px solid var(--outline);border-radius:16px;padding:10px 12px;box-shadow:var(--shadow)}
    .brand{display:flex;gap:10px;align-items:center}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--green);box-shadow:0 0 0 3px rgba(35,196,131,.15)}
    .brand h1{margin:0;font-size:16px;letter-spacing:.3px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid var(--outline);background:#0f1726;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;transition:transform .06s ease,background .2s ease,border .2s ease;display:inline-flex;gap:8px;align-items:center}
    .btn:hover{background:#121c2e;border-color:var(--ring)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg,#1b2a44,#152238);border-color:var(--ring)}
    .btn.ghost{background:transparent}
    .btn.success{border-color:#184f3b;background:#0f1f1a}
    .btn.warn{border-color:#4f3a18;background:#1f1a0f}
    .btn.danger{border-color:#4f1818;background:#1f0f0f}

    .hint{color:var(--muted);font-size:12px;margin-top:8px}

    .wrap{display:grid;grid-template-columns: 280px 1fr;gap:16px;margin-top:16px}

    .panel{background:var(--card);border:1px solid var(--outline);border-radius:16px;box-shadow:var(--shadow)}
    .panel h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--outline);font-size:14px;color:#cfe1ff}
    .panel .body{padding:12px 14px}

    /* Sidebar */
    .year-picker{display:flex;flex-wrap:wrap;gap:8px}
    .chip{padding:6px 10px;border:1px solid var(--outline);border-radius:999px;cursor:pointer}
    .chip.active{background:#182238;border-color:var(--ring)}

    /* Schedule grid (simple, demo) */
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day{background:#0f1624;border:1px solid var(--outline);border-radius:12px;min-height:110px;padding:8px;display:flex;flex-direction:column}
    .day .date{font-size:11px;color:var(--muted);margin-bottom:6px}
    .task{background:#111d31;border:1px dashed #2a3b57;border-radius:8px;padding:6px 8px;font-size:13px;margin-top:6px}

    .legend{display:flex;flex-wrap:wrap;gap:8px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--outline)}
    .swatch{width:14px;height:14px;border-radius:3px;border:1px solid #0001}

    /* Modal */
    dialog{border:none;background:var(--card);color:var(--text);padding:0;border-radius:16px;box-shadow:var(--shadow);width:min(560px,90vw)}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .modal-hd{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--outline)}
    .modal-bd{padding:14px}
    .modal-ft{padding:12px 14px;border-top:1px solid var(--outline);display:flex;gap:8px;justify-content:flex-end}
    input,select,textarea{background:#0e1522;border:1px solid var(--outline);border-radius:10px;padding:8px 10px;color:var(--text);width:100%}
    label{display:block;margin:8px 0 4px;color:#cfe1ff;font-size:13px}

    .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <h1>Outage Planner v3.5 ‚Äî stable single‚Äëfile</h1>
      </div>
      <div class="toolbar">
        <button class="btn primary" id="btn-save-usb" title="Save a .json file you can put on a USB drive">üíæ Save to USB</button>
        <button class="btn" id="btn-email-attach" title="Create a self‚Äëcontained HTML snapshot you can attach to an email">‚úâÔ∏è Create Email Attachment (.html)</button>
        <button class="btn" id="btn-load" title="Load a .json exported earlier">üìÇ Load</button>
        <button class="btn" id="btn-copy-years" title="Copy this year‚Äôs plan to one or more other years">üìÖ Copy to Other Years‚Ä¶</button>
        <button class="btn warn" id="btn-share-html" title="Share as read‚Äëonly HTML for viewing">üîó Share as Read‚ÄëOnly</button>
        <button class="btn danger" id="btn-reset" title="Reset the scheduling template (no PIN; confirmation only)">‚ôªÔ∏è Reset Template</button>
        <button class="btn ghost" id="btn-help">‚ùî Help</button>
      </div>
    </div>

    <p class="hint">Tip: Nothing requires a PIN. <strong>Reset Template</strong> shows a confirmation popup first. ‚ÄúCreate Email Attachment‚Äù downloads a single HTML file with your data embedded‚Äîattach that to an email.
    </p>

    <div class="wrap">
      <aside class="panel">
        <h2>Year & Legends</h2>
        <div class="body">
          <div class="year-picker" id="yearPicker"></div>
          <hr style="border-color:var(--outline);margin:12px 0">
          <div class="legend">
            <span class="pill"><span class="swatch" style="background:#6aa8ff"></span>Planned</span>
            <span class="pill"><span class="swatch" style="background:#23c483"></span>Complete</span>
            <span class="pill"><span class="swatch" style="background:#ffc857"></span>At Risk</span>
            <span class="pill"><span class="swatch" style="background:#ff6b6b"></span>Blocked</span>
          </div>
        </div>
      </aside>

      <main class="panel">
        <h2 id="gridTitle">Schedule ‚Äî <span id="labelYear"></span>, Week <span id="labelWeek"></span></h2>
        <div class="body">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
            <label for="weekSel" class="sr-only">Week</label>
            <select id="weekSel" style="max-width:200px"></select>
            <button class="btn" id="btn-add-demo">‚ûï Add Demo Tasks</button>
          </div>
          <div class="grid" id="grid"></div>
        </div>
      </main>
    </div>
  </div>

  <!-- Copy to other years modal -->
  <dialog id="copyYearsModal">
    <div class="modal-hd">
      <strong>Copy this year to other years</strong>
      <button class="btn ghost" onclick="this.closest('dialog').close()">‚úñ</button>
    </div>
    <div class="modal-bd">
      <p style="margin-top:0;color:var(--muted)">Choose one or more target years. Existing data in those years will be preserved unless the same dates exist, in which case they will be overwritten.</p>
      <label>Target years</label>
      <div id="yearCheckboxes" style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px"></div>
    </div>
    <div class="modal-ft">
      <button class="btn" id="btn-copy-confirm">Copy</button>
      <button class="btn ghost" onclick="copyYearsModal.close()">Cancel</button>
    </div>
  </dialog>

  <script>
  /***** Minimal state & helpers *****/
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const STORAGE_KEY = 'outage_planner_v35';

  const State = {
    year: new Date().getFullYear(),
    week: 1,
    data: { // schedule indexed by YYYY-MM-DD -> array of tasks
      // Example: '2025-10-10': [{text:'Line 3 Roll', status:'planned'}]
    }
  };

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){ Object.assign(State, JSON.parse(raw)); }
    }catch(e){ console.warn('Failed to load state', e); }
  }
  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(State));
  }
  function formatDate(d){ return d.toISOString().slice(0,10); }
  function getISOWeek(date){
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7; // Mon=1..Sun=7
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
  }
  function datesOfISOWeek(week, year){
    const simple = new Date(Date.UTC(year,0,1 + (week-1)*7));
    const dow = simple.getUTCDay();
    const ISOweekStart = simple;
    if(dow <= 4) ISOweekStart.setUTCDate(simple.getUTCDate() - simple.getUTCDay() + 1);
    else ISOweekStart.setUTCDate(simple.getUTCDate() + 8 - simple.getUTCDay());
    return Array.from({length:7},(_,i)=>{
      const d = new Date(ISOweekStart);
      d.setUTCDate(ISOweekStart.getUTCDate()+i);
      return d;
    });
  }

  /***** UI building *****/
  function buildYearPicker(){
    const years = Array.from({length:7}, (_,i)=> State.year - 3 + i);
    const c = $('#yearPicker');
    c.innerHTML = '';
    years.forEach(y=>{
      const el = document.createElement('button');
      el.className = 'chip'+(y===State.year?' active':'');
      el.textContent = y;
      el.onclick = ()=>{ State.year = y; renderGrid(); saveState(); buildYearPicker(); buildWeekOptions(); };
      c.appendChild(el);
    });
  }

  function buildWeekOptions(){
    const sel = $('#weekSel');
    sel.innerHTML = '';
    for(let w=1; w<=53; w++){
      const opt = document.createElement('option');
      opt.value = String(w);
      opt.textContent = `Week ${w}`;
      if(w===State.week) opt.selected = true;
      sel.appendChild(opt);
    }
    sel.onchange = ()=>{ State.week = parseInt(sel.value,10); renderGrid(); saveState(); };
    $('#labelYear').textContent = State.year;
    $('#labelWeek').textContent = State.week;
  }

  function renderGrid(){
    const grid = $('#grid');
    grid.innerHTML = '';
    const days = datesOfISOWeek(State.week, State.year);
    days.forEach(d=>{
      const box = document.createElement('div');
      box.className = 'day';
      const key = formatDate(d);
      const header = document.createElement('div');
      header.className = 'date';
      header.textContent = d.toLocaleDateString(undefined,{weekday:'short', month:'short', day:'numeric'});
      box.appendChild(header);

      const add = document.createElement('button');
      add.className = 'btn ghost';
      add.textContent = 'Ôºã Add task';
      add.style.alignSelf = 'flex-start';
      add.onclick = ()=> addTaskPrompt(key);
      box.appendChild(add);

      (State.data[key]||[]).forEach(t=> box.appendChild(taskEl(key, t)) );
      grid.appendChild(box);
    });
    $('#gridTitle').querySelector('#labelYear');
    $('#labelYear').textContent = State.year;
    $('#labelWeek').textContent = State.week;
  }

  function taskEl(dateKey, task){
    const el = document.createElement('div');
    el.className = 'task';
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <span>${task.text}</span>
        <select aria-label="status">
          <option value="planned" ${task.status==='planned'?'selected':''}>Planned</option>
          <option value="complete" ${task.status==='complete'?'selected':''}>Complete</option>
          <option value="risk" ${task.status==='risk'?'selected':''}>At risk</option>
          <option value="blocked" ${task.status==='blocked'?'selected':''}>Blocked</option>
        </select>
      </div>`;
    $('select', el).onchange = (e)=>{ task.status = e.target.value; saveState(); };
    return el;
  }

  function addTaskPrompt(dateKey){
    const text = prompt(`Add task for ${dateKey}:`, '3 ROLL RUN');
    if(!text) return;
    const t = {text, status:'planned'};
    State.data[dateKey] = State.data[dateKey]||[];
    State.data[dateKey].push(t);
    saveState();
    renderGrid();
  }

  /***** Export / Import *****/
  function download(filename, content, type='application/octet-stream'){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([content], {type}));
    a.download = filename; a.rel='noopener'; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  }

  function exportJSON(){
    const payload = JSON.stringify(State, null, 2);
    const name = `outage_planner_${State.year}_wk${String(State.week).padStart(2,'0')}.json`;
    download(name, payload, 'application/json');
  }

  function exportSelfContainedHTML(){
    const snapshot = {
      year: State.year,
      week: State.week,
      data: State.data
    };
    const html = `<!doctype html><html><head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"><title>Outage Planner ‚Äî snapshot</title></head><body><pre id=\"pre\" style=\"white-space:pre-wrap;font:14px/1.4 ui-monospace,Consolas,Menlo,monospace\"></pre><script>const DATA=${JSON.stringify(snapshot)};document.getElementById('pre').textContent='Outage Planner Snapshot\n\n'+JSON.stringify(DATA,null,2);<\/script></body></html>`;
    const name = `OutagePlanner_${State.year}_Week${State.week}_snapshot.html`;
    download(name, html, 'text/html');
  }

  function exportReadOnlyHTML(){
    // A prettier, read‚Äëonly viewer with the same week grid.
    const days = datesOfISOWeek(State.week, State.year).map(d=>({key: formatDate(d), label: d.toLocaleDateString(undefined,{weekday:'short', month:'short', day:'numeric'})}));
    const rows = days.map(d=>{
      const tasks = (State.data[d.key]||[]).map(t=>`<li><strong>[${t.status}]</strong> ${t.text}</li>`).join('');
      return `<section style="border:1px solid #e4e7ef;border-radius:12px;padding:12px;margin:10px 0"><div style="color:#51607a;font:13px sans-serif">${d.label}</div><ul style="margin:8px 0 0 22px;font:14px sans-serif">${tasks||'<em style=\"color:#8b97ac\">No tasks</em>'}</ul></section>`;
    }).join('');
    const html = `<!doctype html><html><head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"><title>Outage Planner ‚Äî Read‚Äëonly</title><style>body{font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;padding:24px;color:#111733;background:#fff}</style></head><body><h1 style=\"margin:0\">Outage Planner ‚Äî Read‚Äëonly</h1><div style=\"color:#4f5f79\">Year ${State.year}, Week ${State.week}</div>${rows}</body></html>`;
    const name = `OutagePlanner_${State.year}_Week${State.week}_readonly.html`;
    download(name, html, 'text/html');
  }

  function importJSON(){
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = '.json,application/json';
    inp.onchange = ()=>{
      const file = inp.files[0];
      if(!file) return;
      const fr = new FileReader();
      fr.onload = ()=>{
        try{
          const obj = JSON.parse(fr.result);
          if(typeof obj !== 'object') throw new Error('Invalid file');
          State.year = obj.year || State.year;
          State.week = obj.week || State.week;
          State.data = obj.data || {};
          saveState(); buildYearPicker(); buildWeekOptions(); renderGrid();
          alert('Loaded!');
        }catch(e){ alert('Could not load file: '+e.message); }
      };
      fr.readAsText(file);
    };
    inp.click();
  }

  /***** Copy to other years *****/
  function openCopyYearsModal(){
    const modal = $('#copyYearsModal');
    const box = $('#yearCheckboxes');
    const start = State.year - 3, end = State.year + 6;
    box.innerHTML = '';
    for(let y=start; y<=end; y++){
      if(y===State.year) continue;
      const id = 'y_'+y;
      const wrap = document.createElement('label');
      wrap.style.display='flex'; wrap.style.gap='8px'; wrap.style.alignItems='center';
      wrap.innerHTML = `<input type="checkbox" id="${id}" value="${y}"> <span>${y}</span>`;
      box.appendChild(wrap);
    }
    modal.showModal();
  }

  function copyToYears(targetYears){
    // Copy all entries from current year into each target year, shifting the year component but preserving month/day.
    const newData = {...State.data};
    const entries = Object.entries(State.data).filter(([k])=> k.startsWith(String(State.year)) );
    targetYears.forEach(y=>{
      entries.forEach(([key, arr])=>{
        const toKey = y + key.slice(4); // replace YYYY‚Äë
        newData[toKey] = JSON.parse(JSON.stringify(arr));
      });
    });
    State.data = newData; saveState(); renderGrid();
  }

  /***** Reset (no PIN, confirm only) *****/
  function resetTemplate(){
    const ok = confirm('Are you sure you want to reset the scheduling template?\n\nThis clears all tasks and weeks currently saved in this browser.');
    if(!ok) return;
    State.data = {}; saveState(); renderGrid();
  }

  /***** Demo data *****/
  function addDemo(){
    const days = datesOfISOWeek(State.week, State.year);
    const samples = ['3 ROLL RUN','APEX 5 C','GUM S/S/C','BC REWORK RUN','PGI C'];
    days.forEach((d,i)=>{
      const key = formatDate(d);
      State.data[key] = State.data[key]||[];
      State.data[key].push({text: samples[i % samples.length], status: ['planned','complete','risk','blocked'][i%4]});
    });
    saveState(); renderGrid();
  }

  /***** Init *****/
  function init(){
    loadState();
    // default week = current week of chosen year
    if(!State.week){
      const today = new Date();
      if(today.getFullYear()===State.year) State.week = getISOWeek(today);
      else State.week = 1;
    }
    buildYearPicker();
    buildWeekOptions();
    renderGrid();

    // Wire toolbar
    $('#btn-save-usb').onclick = exportJSON;
    $('#btn-email-attach').onclick = exportSelfContainedHTML; // creates an .html you can attach
    $('#btn-load').onclick = importJSON;
    $('#btn-copy-years').onclick = openCopyYearsModal;
    $('#btn-share-html').onclick = exportReadOnlyHTML;
    $('#btn-reset').onclick = resetTemplate;
    $('#btn-help').onclick = ()=> alert('‚Ä¢ Save to USB ‚Üí Downloads a .json backup you can put on a flash drive.\n\n‚Ä¢ Create Email Attachment (.html) ‚Üí Downloads a single self‚Äëcontained HTML snapshot you can attach to any email.\n\n‚Ä¢ Load ‚Üí Load a previously exported .json.\n\n‚Ä¢ Copy to Other Years ‚Üí Copy every entry from the current year into selected target years (month/day preserved).\n\n‚Ä¢ Share as Read‚ÄëOnly ‚Üí Pretty HTML for viewing (no editing).\n\n‚Ä¢ Reset Template ‚Üí Clears all data in this browser after a confirmation popup. No PINs anywhere.');

    $('#btn-add-demo').onclick = addDemo;

    // Copy years modal actions
    $('#btn-copy-confirm').onclick = ()=>{
      const years = $$('#yearCheckboxes input:checked').map(el=> parseInt(el.value,10));
      if(!years.length){ alert('Choose at least one year.'); return; }
      copyToYears(years);
      $('#copyYearsModal').close();
      alert('Copied into: '+years.join(', '));
    };
  }

  init();
  </script>
</body>
</html>
