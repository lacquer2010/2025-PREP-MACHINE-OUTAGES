<!-- Outage Planner v3.5a — hard-coded palette support (LIGHT THEME) -->

<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Outage Planner</title>

<style>
:root{
  --bg:#f4f6fb; --card:#ffffff; --ring:#d6d9e0; --text:#0b0f14;
  --muted:#586173; --accent:#2563eb; --grid:#e5e7eb;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);
     font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
.wrap{max-width:1280px;margin:18px auto;padding:0 16px}
h1{margin:0 0 10px;font-size:24px}
small.muted{color:var(--muted)}

.card{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,.05)}
button{background:#eef2ff;color:#0b0f14;border:1px solid var(--ring);border-radius:10px;padding:8px 10px;cursor:pointer}
button.primary{background:var(--accent);border-color:transparent;color:#fff}
button[disabled]{opacity:.5;cursor:not-allowed}
select,textarea,input[type="text"],input[type="number"]{background:#fff;border:1px solid var(--ring);color:var(--text);border-radius:8px;padding:6px 8px}
textarea{width:100%;min-height:180px}
.toolbar{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0}
.viewtabs{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
.viewtabs button.active{background:var(--accent);border-color:transparent;color:#fff}
.grid{display:grid;grid-template-columns:320px 1fr;gap:12px}

.leftcol .sectionlabel{font-weight:700;margin-bottom:6px}
.rightcol .sectionlabel{font-weight:700;margin-bottom:6px}

.palette{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:10px;max-height:72vh;overflow:auto}
.palette header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.taskchip{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:10px;border-left:6px solid var(--accent);background:#fbfdff;border:1px solid var(--ring);margin:6px 0;cursor:grab;color:var(--text)}
.taskchip .colorbox{width:16px;height:16px;border-radius:4px;border:1px solid var(--ring)}
.badge{display:inline-block;padding:2px 6px;border-radius:999px;border:1px solid var(--ring);font-size:12px;background:#fff}
.banner{margin:10px 0;padding:8px;border-radius:10px;border:1px solid var(--ring)}
.info{background:#f6f8ff}
.error{background:#fff1f2;border-color:#fecdd3;color:#7f1d1d}

.calendar{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:10px}
.weekdays{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:6px}
.weekgrid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.day{border:1px solid var(--ring);border-radius:10px;min-height:120px;padding:8px;background:#fff;position:relative;box-shadow:0 1px 4px rgba(0,0,0,.04)}
.day .date{position:absolute;top:6px;right:8px;font-size:12px;color:#6b7280}
.day .holabel{position:absolute;top:6px;left:8px;font-size:11px;color:#7a5200;background:#fffbe6;border:1px solid #ffe58f;border-radius:6px;padding:2px 6px}
.slot{border:1px dashed var(--grid);border-radius:8px;padding:6px;min-height:38px;margin-top:8px;background:#fafcff}
.slot-title{font-size:11px;color:#6b7280}
.dropzone{min-height:24px}

.entry{margin-top:4px;padding:4px 8px;border-radius:8px;border-left:5px solid var(--accent);background:#fff !important;color:#000 !important;display:flex;justify-content:space-between;align-items:center;gap:8px;border:1px solid var(--ring);box-shadow:0 1px 3px rgba(0,0,0,.06);font-weight:600}
.entry .x{cursor:pointer;font-weight:bold;color:#334155}
.entry[style*="#ff0000"]{color:#fff !important} /* red bg → white text */

.tablewrap{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:10px}
table{width:100%;border-collapse:collapse;background:#fff}
thead th{font-size:12px;color:#475569;text-align:left;border-bottom:1px solid var(--ring);padding:8px;background:#f7f8fb}
tbody td{padding:8px;border-bottom:1px dashed var(--grid);color:#0b0f14}

.controls-row{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.controls-row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.controls-row-4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
summary{cursor:pointer}

.tools{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:10px}
.tools .group{border:1px dashed var(--grid);border-radius:10px;padding:8px;margin-top:8px}
.tools .group h4{margin:0 0 6px 0;font-size:13px;color:#475569}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal .inner{background:#fff;border:1px solid var(--ring);border-radius:12px;max-width:760px;width:100%;padding:12px;color:#0b0f14}
.modal.small .inner{max-width:420px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.hr{height:1px;background:var(--ring);margin:8px 0}
</style>
</head>

<body>
<div class="wrap">
  <h1>Outage Planner</h1>

  <div class="toolbar">
    <div class="card leftcol">
      <div class="controls-row">
        <div>
          <label><small class="muted">Year</small></label><br>
          <select id="yearSel"></select>
        </div>
        <div>
          <label><small class="muted">Month</small></label><br>
          <select id="monthSel"></select>
        </div>
      </div>

      <div class="viewtabs" role="tablist" aria-label="View tabs">
        <button id="tabMonth" class="active">Month View</button>
        <button id="tabWeek">Week View</button>
        <button id="tabYear">Year View</button>
        <button id="tabTable">Table View</button>
      </div>

      <div class="banner info"><small class="muted">
        Drag from palette or move existing entries. Weekends are excluded.
        Holidays are labeled (observed days included) in <b>yellow</b>. If a
        task lands on a holiday it shifts to the <b>previous business day</b>.
        More than two items spill into an <b>EXTRA</b> stack. Empty weekdays export as <b>gray</b>.
      </small></div>
    </div>

    <div class="card rightcol">
      <div class="sectionlabel">Tools</div>
      <div class="tools">
        <div class="group">
          <h4>Scheduling</h4>
          <div class="row">
            <button id="btnCopyMonth">Copy to All Months</button>
            <button id="btnCopyYearRange">Copy to Other Years</button>
          </div>
        </div>

        <div class="group">
          <h4>Data</h4>
          <div class="row">
            <button id="btnBackup">Back Up Schedule</button>
            <input type="file" id="fileRestore" accept=".json" style="display:none">
            <button id="btnRestore">Restore Schedule</button>
          </div>
        </div>

        <div class="group">
          <h4>Share & Print</h4>
          <div class="row">
            <button id="btnPrintMonth">Print Month</button>
            <button id="btnExportHtml">Share as HTML</button>
            <button id="btnExportCSV">Export to Spreadsheet</button>
            <input type="file" id="fileImport" accept=".csv" style="display:none">
            <button id="btnImportCSV">Import Spreadsheet</button>
          </div>
        </div>

        <div class="group">
          <h4>Filters</h4>
          <div class="row">
            <button id="fltAll" class="primary">Show All</button>
            <button id="fltPreventive">Only: Preventive</button>
            <button id="fltRun">Only: Run</button>
            <div class="row" style="gap:6px">
              <label><small class="muted">Custom…</small></label>
              <select id="customFilterKind">
                <option value="color">by color</option>
                <option value="text">by text contains</option>
              </select>
              <input id="customFilterVal" type="text" placeholder="#hex or text…">
              <button id="btnApplyCustom">Apply</button>
            </div>
          </div>
        </div>

        <div class="group">
          <h4>Cleanup</h4>
          <div class="row">
            <button id="btnClearMonth">Clear This Month</button>
            <button id="btnResetAll">Reset Everything</button>
          </div>
        </div>
      </div>

      <div id="msg" class="banner error" style="display:none;margin-top:8px"></div>
    </div>
  </div>

  <div class="grid">
    <div class="palette">
      <header>
        <div class="sectionlabel">Task palette</div>
        <div style="display:flex;gap:6px">
          <button id="btnAdd">+ Add Task</button>
          <button id="btnEditPalette">Edit Tasks</button>
        </div>
      </header>

      <details style="margin-bottom:8px">
        <summary><strong>Repeat</strong></summary>
        <div class="controls-row-4" style="margin-top:8px">
          <div>
            <label><small class="muted">Task</small></label><br>
            <select id="repeatTask"></select>
          </div>
          <div>
            <label><small class="muted">Day/Pattern</small></label><br>
            <select id="repeatRule">
              <option>Every weekday (Mon–Fri)</option>
              <option>Every Monday</option>
              <option>Every Tuesday</option>
              <option>Every Wednesday</option>
              <option>Every Thursday</option>
              <option>Every Friday</option>
              <option>1st Monday</option><option>2nd Monday</option><option>3rd Monday</option><option>4th Monday</option><option>Last Monday</option>
              <option>1st Tuesday</option><option>2nd Tuesday</option><option>3rd Tuesday</option><option>4th Tuesday</option><option>Last Tuesday</option>
              <option>1st Wednesday</option><option>2nd Wednesday</option><option>3rd Wednesday</option><option>4th Wednesday</option><option>Last Wednesday</option>
              <option>1st Thursday</option><option>2nd Thursday</option><option>3rd Thursday</option><option>4th Thursday</option><option>Last Thursday</option>
              <option>1st Friday</option><option>2nd Friday</option><option>3rd Friday</option><option>4th Friday</option><option>Last Friday</option>
            </select>
          </div>
          <div>
            <label><small class="muted">Slot</small></label><br>
            <select id="repeatSlot"><option>AM</option><option>PM</option></select>
          </div>
          <div>
            <label><small class="muted">For N weeks</small></label><br>
            <input id="repeatWeeks" type="number" min="1" max="52" value="4">
          </div>
        </div>
        <button id="btnApplyRepeat" class="primary" style="margin-top:8px">Apply</button>
      </details>

      <div id="paletteList"></div>
    </div>

    <div>
      <div id="monthView" class="calendar" aria-label="Month view"></div>

      <div id="weekView" class="calendar" style="display:none" aria-label="Week view">
        <div class="weekdays" id="weekHead"></div>
        <div class="weekgrid" id="weekGrid"></div>
      </div>

      <div id="yearView" class="calendar" style="display:none" aria-label="Year view">
        <div id="yearGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px"></div>
      </div>

      <div id="tableView" class="tablewrap" style="display:none">
        <table>
          <thead><tr><th>Date</th><th>Slot</th><th>Title</th><th>BG</th><th>Font</th></tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Seed CSV Modal (kept) -->
<div id="seedModal" class="modal">
  <div class="inner">
    <h3>Paste seed CSV</h3>
    <p style="margin-top:0"><small class="muted">
      Columns required: <b>year,month,date,slot,title,bg,font</b> — OR use <b>day</b> instead of <b>date</b>.
      Example rows:<br>
      2025,8,2025-08-01,AM,QUAD RUN,#b1a0c7,#000000<br>
      2025,8,1,PM,BF3 RUN,#b7dee8,#000000
    </small></p>
    <textarea id="seedText" placeholder="Paste CSV here…"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="seedCancel">Cancel</button>
      <button id="seedApply" class="primary">Apply</button>
    </div>
  </div>
</div>

<!-- Copy Year Range Modal -->
<div id="yearRangeModal" class="modal small">
  <div class="inner">
    <h3>Copy to Other Years</h3>
    <div class="row" style="margin-top:6px">
      <div><small class="muted">From</small><br><input id="cpyFrom" type="number" style="width:120px"></div>
      <div><small class="muted">To (start)</small><br><input id="cpyStart" type="number" style="width:120px"></div>
      <div><small class="muted">To (end)</small><br><input id="cpyEnd" type="number" style="width:120px"></div>
    </div>
    <div class="hr"></div>
    <div class="row" style="justify-content:flex-end">
      <button id="cpyCancel">Cancel</button>
      <button id="cpyApply" class="primary">Copy</button>
    </div>
  </div>
</div>

<!-- Confirm Modal (generic YES/NO) -->
<div id="confirmModal" class="modal small">
  <div class="inner">
    <h3 id="confirmTitle">Confirm</h3>
    <p id="confirmMsg" style="margin-top:6px"></p>
    <div class="row" style="justify-content:flex-end">
      <button id="cnfNo">No</button>
      <button id="cnfYes" class="primary">Yes</button>
    </div>
  </div>
</div>

<script>
// ===== tiny DOM helpers =====
const $ = sel => document.querySelector(sel);
const el = (t,props={}) => Object.assign(document.createElement(t),props);
const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const WEEKDAYS = ["Mon","Tue","Wed","Thu","Fri"];

// ===== HARD-CODED TASKS: paste your CSV between the backticks =====
const FORCE_CODE_PALETTE = true; // set false to stop overriding localStorage
const TASKS_CSV = `title,bg,font
PASTE_YOUR_CSV_HERE
`;
// Examples (delete these when you paste):
// title,bg,font
// 3 ROLL RUN,#b1a0c7,#000000
// APEX 1 RUN,#b7dee8,#000000
// BC REWORK S/S/C,#b7dee8,#ff0000
// Gas Cementers,#ff0000,#ffffff

// Parse a simple "title,bg,font" CSV (header optional).
function parsePaletteCSV(text){
  const lines = text.trim().split(/\r?\n/).filter(Boolean);
  if(!lines.length) return [];
  // detect header
  let startIdx = 0;
  let header = lines[0].toLowerCase();
  let hasHeader = /(title|bg|font)/.test(header);
  const rows = hasHeader ? lines.slice(1) : lines;
  return rows.map(ln=>{
    const cells = ln.match(/"((?:[^"]|"")*)"|[^,]+/g)?.map(c=>c.replace(/^"|"$/g,"").replace(/""/g,'"')) || [];
    const [title,bg,font] = cells;
    if(!title) return null;
    return { title: title.trim(), bg: (bg||"#ffffff").trim(), font: (font||"#000000").trim() };
  }).filter(Boolean);
}

// ---------- State ----------
let state = JSON.parse(localStorage.getItem("outagePlanner_v34")||"null") || {
  palette: [
    palette: [
  {title:"PGI C", bg:"#B1A0C7", font:"#FF0000"},
  {title:"BC REWORK S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"VMI 1 C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"3 ROLL C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"TL2 RUN", bg:"#B1A0C3", font:"#000000"},
  {title:"APEX 1 RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"FISCHER 1 S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"VMI 2 C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"GUM C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"TL5 RUN", bg:"#B1A0C3", font:"#000000"},
  {title:"APEX 2 RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"WSW S/S/C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"FISCHER 2 S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"VMI 3 C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"JOHNSTONE C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"RECOUP RUN", bg:"#B1A0C3", font:"#000000"},
  {title:"APEX 3 RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"QUAD S/S/C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"VMI REWORK C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"WSW PULLDOWN C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"PGI RUN", bg:"#B1A0C3", font:"#000000"},
  {title:"APEX 4 RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"QUINT S/S/C", bg:"#B1A0C3", font:"#FF0004"},
  /* (Skipped CSV line 25: blank title) */
  {title:"BC 3 C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"TL2 S/S/C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"3 ROLL RUN", bg:"#FF0000", font:"#000000"},
  {title:"APEX 5 RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"GUM RUN", bg:"#B1A0C3", font:"#000000"},
  {title:"APEX 6 RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"BC 8 C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"BF2 S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"TL5 S/S/C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"WSW C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"JOHNSTONE RUN", bg:"#B1A0C3", font:"#000000"},
  {title:"FF 5/6 RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"BC 9 C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"BF3 S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"RECOUP S/S/C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"QUAD C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"FF 7/9 RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"BC 10 C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"BF6 S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"PGI S/S/C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"QUINT C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"VMI 1 RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"APEX 1 S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"TL2 C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"TL3 C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"WSW RUN", bg:"#B1A0C3", font:"#000000"},
  {title:"VMI 2 RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"FISCHER 1 C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"APEX 2 S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"GUM S/S/C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"TL5 C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"QUAD RUN", bg:"#B1A0C3", font:"#000000"},
  {title:"VMI 3 RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"FISCHER 2 C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"APEX 3 S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"JOHNSTONE S/S/C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"RECOUP C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"QUINT RUN", bg:"#B1A0C3", font:"#000000"},
  {title:"VMI REWORK RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"APEX 4 S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"WSW PULLDOWN S/S/C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"TL2 RUN", bg:"#B1A0C3", font:"#000000"},
  {title:"PGI C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"TL2 RUN", bg:"#B1A0C3", font:"#000000"},
  {title:"BC 3 RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"APEX 5 S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"3 ROLL C", bg:"#FF0000", font:"#000000"},
  {title:"BF2 C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"GUM C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"APEX 6 S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"TL5 RUN", bg:"#B1A0C3", font:"#000000"},
  {title:"BC8 RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"WSW S/C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"RECOUP RUN", bg:"#B1A0C3", font:"#000000"},
  {title:"BC 9 RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"FF 5/6 S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"BF3 C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"JOHNSTONE C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"QUAD S/C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"PGI RUN", bg:"#B1A0C3", font:"#000000"},
  {title:"BC 10 RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"FF 7/9 S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"BF6 C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"WSW PULLDOWN C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"QUINT S/C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"3 ROLL RUN", bg:"#FF0000", font:"#000000"},
  {title:"BC REWORK RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"TL2 S/S/C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"VMI 1 S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"APEX 1 C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"TL5 S/S/C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"VMI 2 S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"VMI 2 S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"GUM RUN", bg:"#B1A0C3", font:"#000000"},
  {title:"FISCHER 1 RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"WSW C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"VMI 3 S/S/C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"APEX 3 C", bg:"#B7DEE4", font:"#FF0004"},
  {title:"RECOUP S/C", bg:"#B1A0C3", font:"#FF0004"},
  {title:"JOHNSTONE RUN", bg:"#B1A0C3", font:"#000000"},
  {title:"FISCHER 2 RUN", bg:"#B7DEE4", font:"#000000"},
  {title:"QUAD C", bg:"#B1A0C3", font:"#FF0004"}
],

  ],
  months: {},
  year: 2025, month: 10
};

// If you provided a CSV above, override the palette from code:
(function maybeOverridePalette(){
  if(!FORCE_CODE_PALETTE) return;
  const parsed = parsePaletteCSV(TASKS_CSV);
  if(parsed.length){
    state.palette = parsed;
    // keep existing months, just refresh palette; persist so everyone sees same list
    localStorage.setItem("outagePlanner_v34", JSON.stringify(state));
  }
})();

// ---------- Helpers ----------
function pad(n){ return String(n).padStart(2,"0"); }
function keyFor(y,m){ return `${y}-${pad(m)}`; }
function dstr(y,m,day){ return `${y}-${pad(m)}-${pad(day)}`; }
function isWeekend(d){ const w=d.getDay(); return w===0 || w===6; }
function prevBusiness(d){ let x=new Date(d); x.setDate(x.getDate()-1); while(isWeekend(x)) x.setDate(x.getDate()-1); return x; }
function ensureMonth(state,y,m){ const k = keyFor(y,m); if(!state.months[k]) state.months[k] = {}; return k; }
function msg(t){ const n=$("#msg"); n.textContent=t; n.style.display="block"; setTimeout(()=>n.style.display="none",3000); }
function save(){ localStorage.setItem("outagePlanner_v34", JSON.stringify(state)); }

// ---------- Holidays ----------
function easter(year){const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),mo=Math.floor((h+l-7*m+114)/31),da=((h+l-7*m+114)%31)+1;return new Date(year,mo-1,da);}
function nthWeekday(year,month,weekday,n){const d=new Date(year,month-1,1);let c=0;while(d.getMonth()===month-1){if(d.getDay()===weekday){c++;if(c===n)return new Date(d);}d.setDate(d.getDate()+1);}return null;}
function lastWeekday(year,month,weekday){const d=new Date(year,month,0);while(d.getDay()!==weekday)d.setDate(d.getDate()-1);return d;}
function holidayMap(year){
  const H={}; const add=(dt, label, observe=true)=>{
    const k=dstr(dt.getFullYear(), dt.getMonth()+1, dt.getDate()); H[k]=label;
    if(observe){const wd=dt.getDay(); if(wd===6){const o=new Date(dt);o.setDate(o.getDate()-1);H[dstr(o.getFullYear(),o.getMonth()+1,o.getDate())]=label+" (observed)";}
                  if(wd===0){const o=new Date(dt);o.setDate(o.getDate()+1);H[dstr(o.getFullYear(),o.getMonth()+1,o.getDate())]=label+" (observed)";}}
  };
  add(new Date(year,0,1),"New Year’s Day");
  H[dstr(year,0, nthWeekday(year,1,1,3).getDate())] = "MLK Day";
  H[dstr(year,1, nthWeekday(year,2,1,3).getDate())] = "Presidents Day";
  H[dstr(year,4, lastWeekday(year,5,1).getDate())]  = "Memorial Day";
  add(new Date(year,5,19),"Juneteenth");
  add(new Date(year,6,4),"Independence Day");
  H[dstr(year,9, nthWeekday(year,10,1,2).getDate())]  = "Columbus Day";
  add(new Date(year,10,11),"Veterans Day");
  const thx = nthWeekday(year,11,4,4); H[dstr(thx.getFullYear(),12,thx.getDate())]="Thanksgiving";
  const bf = new Date(thx); bf.setDate(bf.getDate()+1); H[dstr(bf.getFullYear(),12,bf.getDate())]="Black Friday";
  H[dstr(year,12,24)]="Christmas Eve"; add(new Date(year,11,25),"Christmas Day"); H[dstr(year,12,31)]="New Year’s Eve";
  const eas = easter(year); H[dstr(eas.getFullYear(), eas.getMonth()+1, eas.getDate())] = "Easter";
  const gf = new Date(eas); gf.setDate(gf.getDate()-2); H[dstr(gf.getFullYear(), gf.getMonth()+1, gf.getDate())] = "Good Friday";
  return H;
}
const holidayCache = {};
function getHolidays(y){ if(!holidayCache[y]) holidayCache[y]=holidayMap(y); return holidayCache[y]; }

// ---------- Rendering (Month/Week/Year/Table) ----------
function renderMonth(){
  const y = Number($("#yearSel").value), m = Number($("#monthSel").value);
  const H = getHolidays(y);
  const start = new Date(y, m-1, 1);
  const end   = new Date(y, m, 0);
  const k = ensureMonth(state,y,m);
  const container = $("#monthView"); container.innerHTML = "";

  const head = el("div",{className:"weekdays"});
  WEEKDAYS.forEach(w => head.append(el("div",{textContent:w, className:"badge"})));
  container.append(head);

  const grid = el("div",{className:"weekgrid"});
  for(let d = new Date(start); d <= end; d.setDate(d.getDate()+1)){
    const wd = d.getDay(); if(wd===0 || wd===6) continue;
    const ds = dstr(y,m,d.getDate());
    const day = el("div",{className:"day"});
    day.append(el("div",{className:"date",textContent: d.toLocaleDateString(undefined,{month:"short",day:"numeric"})}));
    const hol = H[ds]; if(hol){ day.append(el("div",{className:"holabel",textContent:hol})); }

    const mkSlot = (slotName)=>{
      const slot = el("div",{className:"slot"});
      slot.append(el("div",{className:"slot-title",textContent:slotName}));
      const dz = el("div",{className:"dropzone"}); dz.dataset.ds = ds; dz.dataset.slot = slotName.startsWith("AM")?"AM":"PM";
      dz.addEventListener("dragover", e=>e.preventDefault());
      dz.addEventListener("drop", onDropFromPalette);
      slot.append(dz);
      const rec = state.months[k][ds] || {AM:[],PM:[],EXTRA:[]};
      const arr = slotName.startsWith("AM") ? rec.AM : rec.PM;
      arr.forEach(item => dz.append(renderEntry(ds, slotName.startsWith("AM")?"AM":"PM", item)));
      return slot;
    };
    day.append(mkSlot("AM"), mkSlot("PM"));
    grid.append(day);
  }
  container.append(grid);
  setActiveView("month");
}

function renderWeek(){
  const y = Number($("#yearSel").value), m = Number($("#monthSel").value);
  const H = getHolidays(y);
  let firstWeekday = new Date(y, m-1, 1);
  while(firstWeekday.getDay()===0 || firstWeekday.getDay()===6) firstWeekday.setDate(firstWeekday.getDate()+1);

  const weekHead = $("#weekHead"); const weekGrid=$("#weekGrid");
  weekHead.innerHTML=""; weekGrid.innerHTML="";
  WEEKDAYS.forEach(w => weekHead.append(el("div",{textContent:w, className:"badge"})));

  const k = ensureMonth(state,y,m);
  for(let i=0;i<5;i++){
    const d = new Date(firstWeekday); d.setDate(d.getDate()+i);
    const ds = dstr(d.getFullYear(), d.getMonth()+1, d.getDate());
    const day = el("div",{className:"day"});
    day.append(el("div",{className:"date",textContent:d.toLocaleDateString(undefined,{month:"short",day:"numeric"})}));
    const hol = H[ds]; if(hol){ day.append(el("div",{className:"holabel",textContent:hol})); }

    const mkSlot = (slotName)=>{
      const slot = el("div",{className:"slot"}); slot.append(el("div",{className:"slot-title",textContent:slotName}));
      const dz = el("div",{className:"dropzone"}); dz.dataset.ds = ds; dz.dataset.slot = slotName.startsWith("AM")?"AM":"PM";
      dz.addEventListener("dragover", e=>e.preventDefault()); dz.addEventListener("drop", onDropFromPalette); slot.append(dz);
      const rec = state.months[k][ds] || {AM:[],PM:[],EXTRA:[]};
      const arr = slotName.startsWith("AM") ? rec.AM : rec.PM;
      arr.forEach(item => dz.append(renderEntry(ds, slotName.startsWith("AM")?"AM":"PM", item)));
      return slot;
    };
    day.append(mkSlot("AM"), mkSlot("PM"));
    weekGrid.append(day);
  }
  setActiveView("week");
}

function renderYear(){
  const y = Number($("#yearSel").value);
  const grid = $("#yearGrid"); grid.innerHTML="";
  for(let m=1;m<=12;m++){
    const card = el("div",{className:"card"});
    card.append(el("div",{className:"badge",textContent:MONTHS[m-1]}));
    const inner = el("div",{style:"display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:6px"});
    const start = new Date(y,m-1,1), end=new Date(y,m,0);
    let count=0; const k = ensureMonth(state,y,m);
    for(let d=new Date(start); d<=end && count<15; d.setDate(d.getDate()+1)){
      if(d.getDay()===0||d.getDay()===6) continue;
      const ds=dstr(y,m,d.getDate());
      const rec = state.months[k][ds] || {AM:[],PM:[]};
      const cell = el("div",{style:"border:1px solid var(--ring);border-radius:8px;padding:4px;background:#fff;min-height:38px"});
      cell.append(el("div",{style:"font-size:11px;color:#6b7280;text-align:right",textContent:d.getDate()}));
      if(rec.AM.length||rec.PM.length){
        const t = (rec.AM[0]?.title || rec.PM[0]?.title || "");
        cell.append(el("div",{style:"font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis",textContent:t}));
      }
      inner.append(cell); count++;
    }
    card.append(inner);
    grid.append(card);
  }
  setActiveView("year");
}

function renderEntry(ds,slot,item){
  const div = el("div",{className:"entry"});
  div.style.background = item.bg || "#ffffff";
  div.style.color = (item.font || "#000000");
  div.draggable = true;
  div.addEventListener("dragstart", e=>{
    e.dataTransfer.setData("text/plain", JSON.stringify({type:"move", ds, slot, item}));
  });
  const label = el("span",{textContent:item.title});
  const x = el("span",{className:"x",textContent:"✕"});
  x.addEventListener("click", ()=>removeEntry(ds,slot,item));
  div.append(label,x);
  return div;
}

function renderTable(){
  const y = Number($("#yearSel").value), m = Number($("#monthSel").value);
  const k = ensureMonth(state,y,m), body = $("#tableBody"); body.innerHTML="";
  const days = Object.keys(state.months[k]).sort();
  for(const ds of days){
    const rec = state.months[k][ds]; if(!rec) continue;
    [["AM",rec.AM],["PM",rec.PM]].forEach(([slot,arr])=>{
      if(arr.length===0) return;
      arr.forEach(it=>{
        const tr = el("tr");
        tr.append(el("td",{textContent: ds}), el("td",{textContent:slot}),
                 el("td",{textContent:it.title}), el("td",{textContent:it.bg}), el("td",{textContent:it.font}));
        body.append(tr);
      });
    });
  }
}

function setActiveView(which){
  $("#tabMonth").classList.toggle("active", which==="month");
  $("#tabWeek").classList.toggle("active", which==="week");
  $("#tabYear").classList.toggle("active", which==="year");
  $("#tabTable").classList.toggle("active", which==="table");
  $("#monthView").style.display = which==="month" ? "block" : "none";
  $("#weekView").style.display  = which==="week"  ? "block" : "none";
  $("#yearView").style.display  = which==="year"  ? "block" : "none";
  $("#tableView").style.display = which==="table" ? "block" : "none";
}

// ---------- Palette ----------
function refreshPalette(){
  const list = $("#paletteList"); list.innerHTML="";
  state.palette.forEach((p)=>{
    const chip = el("div",{className:"taskchip",draggable:true});
    const cb = el("div",{className:"colorbox"}); cb.style.background = p.bg || "#fff";
    const name = el("div",{textContent:p.title});
    chip.append(cb, name, el("span",{className:"badge",textContent:p.font||"#000000"}));
    chip.addEventListener("dragstart", e=>{
      e.dataTransfer.setData("text/plain", JSON.stringify({type:"palette", title:p.title, bg:p.bg, font:p.font}));
    });
    list.append(chip);
  });
  const sel=$("#repeatTask"); sel.innerHTML="";
  state.palette.forEach(p => sel.append(el("option",{textContent:p.title})));
}

function onDropFromPalette(e){
  e.preventDefault();
  const data = JSON.parse(e.dataTransfer.getData("text/plain"));
  const ds = e.currentTarget.dataset.ds;
  const slot = e.currentTarget.dataset.slot;
  if(data.type==="palette"){
    const item = {title:data.title, bg:data.bg||"#ffffff", font:(data.font||"#000000")};
    placeItem(ds, slot, item, true);
  }else if(data.type==="move"){
    removeEntry(data.ds, data.slot, data.item, false);
    placeItem(ds, slot, data.item, true);
  }
}

function removeEntry(ds,slot,item, saveAfter=true){
  const [y,m] = ds.split("-").map(Number);
  const k = ensureMonth(state,y,m);
  const arr = state.months[k][ds]?.[slot] || [];
  const idx = arr.findIndex(x => x.title===item.title && x.bg===item.bg && x.font===item.font);
  if(idx>-1){ arr.splice(idx,1); if(saveAfter){ save(); renderCurrent(); } }
}

function placeItem(ds,slot,item, shiftForHoliday){
  const [y,m,d] = ds.split("-").map(n=>Number(n));
  const H = getHolidays(y);
  let dateObj = new Date(y, m-1, d);
  if(shiftForHoliday && H[ds]){
    let p = prevBusiness(dateObj);
    while(getHolidays(p.getFullYear())[dstr(p.getFullYear(),p.getMonth()+1,p.getDate())]) p = prevBusiness(p);
    dateObj = p;
  }
  const nds = dstr(dateObj.getFullYear(), dateObj.getMonth()+1, dateObj.getDate());
  const k = ensureMonth(state, dateObj.getFullYear(), dateObj.getMonth()+1);
  if(!state.months[k][nds]) state.months[k][nds] = {AM:[],PM:[],EXTRA:[]};
  state.months[k][nds][slot].push(item);
  save(); renderCurrent();
}

function renderCurrent(){
  const which = $("#tabMonth").classList.contains("active") ? "month" :
                $("#tabWeek").classList.contains("active")  ? "week"  :
                $("#tabYear").classList.contains("active")  ? "year"  : "table";
  if(which==="month") renderMonth();
  else if(which==="week") renderWeek();
  else if(which==="year") renderYear();
  else { renderTable(); setActiveView("table"); }
}

// ---------- Export / Import ----------
function exportCSV(){
  const y = Number($("#yearSel").value), m = Number($("#monthSel").value);
  const k = ensureMonth(state,y,m);
  let out = "year,month,date,slot,title,bg,font\n";
  for(const ds of Object.keys(state.months[k]).sort()){
    const rec = state.months[k][ds]; if(!rec) continue;
    [["AM",rec.AM],["PM",rec.PM]].forEach(([slot,arr])=>{
      if(arr.length===0){
        out += `${y},${m},${ds},${slot},,,\n`;
      }else{
        arr.forEach(it=> out += `${y},${m},${ds},${slot},${csvEscape(it.title)},${it.bg||""},${it.font||""}\n`);
      }
    });
  }
  download("placements_"+y+"_"+pad(m)+".csv", out);
}
function csvEscape(s){ if(!s) return ""; if(/[",\n]/.test(s)) return '"'+s.replace(/"/g,'""')+'"'; return s; }
function download(name,text){
  const a=el("a",{href:"data:text/plain;charset=utf-8,"+encodeURIComponent(text),download:name}); document.body.append(a); a.click(); a.remove();
}

function exportMonthHTML(){
  const y = Number($("#yearSel").value), m = Number($("#monthSel").value);
  const w = window.open("","_blank");
  const title = `${MONTHS[m-1]} ${y} — Outage Planner`;
  const cont = $("#monthView").innerHTML;
  w.document.write(`<!doctype html><meta charset="utf-8"><title>${title}</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#fff;color:#111;margin:16px}
    .weekdays,.weekgrid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    .badge{padding:2px 6px;border:1px solid #ccc;border-radius:999px;font-size:12px;text-align:center}
    .day{position:relative;border:1px solid #ccc;border-radius:10px;min-height:120px;padding:8px;background:#fff}
    .date{position:absolute;top:6px;right:8px;font-size:12px;color:#555}
    .slot{border:1px dashed #ddd;border-radius:8px;padding:6px;min-height:38px;margin-top:8px;background:#fafafa}
    .entry{margin-top:4px;padding:4px 8px;border-radius:8px;border:1px solid #ddd;background:#fff;font-weight:600}
    .x{display:none}
  </style>
  <h2>${title}</h2><div>${cont}</div>`);
  w.document.close();
}

function importCSVFile(file){ const r = new FileReader(); r.onload = () => applyCSV(r.result); r.readAsText(file); }
function importCSVText(text){ applyCSV(text); }
function applyCSV(text){
  const lines = text.trim().split(/\r?\n/);
  if(!lines.length) { msg("Empty CSV"); return; }
  const head = lines.shift().split(",").map(s=>s.trim().replace(/^"|"$/g,""));
  const idx = {year: head.indexOf("year"), month: head.indexOf("month"), date: head.indexOf("date"), day: head.indexOf("day"), slot: head.indexOf("slot"), title:head.indexOf("title"), bg:head.indexOf("bg"), font: head.indexOf("font")};
  if(idx.year<0||idx.month<0||(idx.date<0&&idx.day<0)||idx.slot<0||idx.title<0){ msg("CSV needs columns: year, month, (date OR day), slot, title [, bg, font]"); return; }
  for(const ln of lines){
    if(!ln.trim()) continue;
    const cells = ln.match(/"((?:[^"]|"")*)"|[^,]+/g).map(c=>c.replace(/^"|"$/g,"").replace(/""/g,'"'));
    const y = Number(cells[idx.year]), m = Number(cells[idx.month]);
    const slot = (cells[idx.slot]||"AM").toUpperCase();
    const title = (cells[idx.title]||"").trim(); if(!title) continue;
    let ds = "";
    if(idx.date>-1){
      const raw = cells[idx.date].trim();
      if(/^\d{4}-\d{1,2}-\d{1,2}$/.test(raw)) ds = raw;
      else if(/^\d{1,2}$/.test(raw)) ds = dstr(y,m,Number(raw));
      else continue;
    }else{
      const day = Number(cells[idx.day]); ds = dstr(y,m,day);
    }
    let bg = (cells[idx.bg]||"").trim() || "#ffffff";
    let font = (cells[idx.font]||"").trim() || "#000000";
    const k = ensureMonth(state,y,m);
    if(!state.months[k][ds]) state.months[k][ds] = {AM:[],PM:[],EXTRA:[]};
    if(slot==="AM"||slot==="PM") state.months[k][ds][slot].push({title,bg,font});
    else state.months[k][ds].EXTRA.push({title,bg,font});
  }
  save(); renderCurrent(); msg("Imported spreadsheet.");
}

// ---------- Repeat tools ----------
function weekdayIndex(name){ return ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"].findIndex(n=>n.startsWith(name)); }
function applyRepeat(){
  const taskTitle = $("#repeatTask").value;
  const rule = $("#repeatRule").value;
  const slot = $("#repeatSlot").value;
  const weeks = Math.max(1, Math.min(52, Number($("#repeatWeeks").value)||4));
  const y = Number($("#yearSel").value), m = Number($("#monthSel").value);
  const paletteItem = state.palette.find(p=>p.title===taskTitle);
  if(!paletteItem) return;

  let start = new Date(y,m-1,1);
  let days=[];
  if(rule==="Every weekday (Mon–Fri)"){
    let d=new Date(start);
    while(d.getMonth()===m-1){ if(d.getDay()>=1 && d.getDay()<=5) days.push(new Date(d)); d.setDate(d.getDate()+1); }
  }else if(rule.startsWith("Every ")){
    const wd = weekdayIndex(rule.split(" ")[1]);
    let d=new Date(start);
    while(d.getMonth()===m-1){ if(d.getDay()===wd) days.push(new Date(d)); d.setDate(d.getDate()+1); }
  }else{
    const [ord, dayname] = rule.split(" ");
    const ordMap={"1st":1,"2nd":2,"3rd":3,"4th":4,"Last":"Last"};
    const wd = weekdayIndex(dayname);
    if(ordMap[ord]==="Last"){ let d=lastWeekday(y,m,wd); if(d) days=[d]; }
    else{ let d=nthWeekday(y,m,wd,ordMap[ord]); if(d) days=[d]; }
  }

  const item = {title:paletteItem.title, bg:paletteItem.bg, font:paletteItem.font};
  days.slice(0, weeks*5).forEach(d=>{
    const ds = dstr(d.getFullYear(), d.getMonth()+1, d.getDate());
    placeItem(ds, slot, item, true);
  });
  msg("Repeat applied.");
}

// ---------- Scheduling copy helpers ----------
function copyMonthToAllMonths(){
  const y = Number($("#yearSel").value), m = Number($("#monthSel").value);
  const k = ensureMonth(state,y,m);
  const src = JSON.parse(JSON.stringify(state.months[k]||{}));
  for(let mm=1; mm<=12; mm++){
    if(mm===m) continue;
    const k2 = ensureMonth(state,y,mm);
    state.months[k2] = JSON.parse(JSON.stringify(src));
  }
  save(); msg("Copied to all months of "+y); renderCurrent();
}
function copyYearToRange(fromYear, startYear, endYear){
  for(let y=startYear; y<=endYear; y++){
    if(y===fromYear) continue;
    for(let m=1; m<=12; m++){
      const kFrom = ensureMonth(state, fromYear, m);
      const kTo   = ensureMonth(state, y, m);
      state.months[kTo] = JSON.parse(JSON.stringify(state.months[kFrom]||{}));
    }
  }
  save(); msg(`Copied ${fromYear} → ${startYear}-${endYear}`); renderCurrent();
}

// ---------- Filters ----------
let currentFilter = { mode:"all", value:"" };
function applyFilter(){
  const entries = document.querySelectorAll(".entry");
  entries.forEach(div=>{
    const title = div.querySelector("span")?.textContent || "";
    const bg = (div.style.background||"").toLowerCase();
    let show = true;
    if(currentFilter.mode==="run"){ show = /run/i.test(title); }
    else if(currentFilter.mode==="preventive"){ show = /(S\/S\/C|\bC\b|\bC$)/i.test(title); }
    else if(currentFilter.mode==="color"){ const val=currentFilter.value.toLowerCase().trim(); show = bg.includes(val); }
    else if(currentFilter.mode==="text"){ const val=currentFilter.value.toLowerCase(); show = title.toLowerCase().includes(val); }
    div.style.display = show ? "" : "none";
  });
}
const setFilter = (mode,val="") => { currentFilter={mode,value:val}; applyFilter(); }

// ---------- Backup / Restore / Print ----------
function backupJSON(){ download("outage_planner_backup.json", JSON.stringify(state,null,2)); }
function restoreJSON(file){
  const r=new FileReader();
  r.onload=()=>{ try{ const data=JSON.parse(r.result); if(!data||typeof data!=="object") throw 0;
    state=data; save(); renderCurrent(); refreshPalette(); msg("Schedule restored.");
  }catch(e){ msg("Invalid backup file."); }};
  r.readAsText(file);
}
function printMonth(){ window.print(); }

// ---------- UI wiring / boot ----------
function buildSelectors(){
  const ys = $("#yearSel"), ms=$("#monthSel");
  ys.innerHTML=""; ms.innerHTML="";

  for(let y=2024; y<=2032; y++){
    ys.append(el("option",{value:y,textContent:y}));
  }
  for(let m=1; m<=12; m++){
    ms.append(el("option",{value:m,textContent:MONTHS[m-1]}));
  }

  ys.value = state.year || new Date().getFullYear();
  ms.value = state.month || (new Date().getMonth()+1);

  ys.addEventListener("change", ()=>{
    state.year = Number(ys.value);
    save();
    renderCurrent();
  });

  ms.addEventListener("change", ()=>{
    state.month = Number(ms.value);
    save();
    renderCurrent();
  });
}

function bindButtons(){
  // Tabs
  $("#tabMonth").addEventListener("click",()=>renderMonth());
  $("#tabWeek").addEventListener("click",()=>renderWeek());
  $("#tabYear").addEventListener("click",()=>renderYear());
  $("#tabTable").addEventListener("click",()=>{ renderTable(); setActiveView("table"); });

  // Scheduling
  $("#btnCopyMonth").addEventListener("click", copyMonthToAllMonths);
  $("#btnCopyYearRange").addEventListener("click", ()=>{
    $("#yearRangeModal").style.display="flex";
    $("#cpyFrom").value  = Number($("#yearSel").value);
    $("#cpyStart").value = Number($("#yearSel").value)+1;
    $("#cpyEnd").value   = Number($("#yearSel").value)+3;
  });
  $("#cpyCancel").addEventListener("click", ()=>$("#yearRangeModal").style.display="none");
  $("#cpyApply").addEventListener("click", ()=>{
    const f=Number($("#cpyFrom").value), s=Number($("#cpyStart").value), e=Number($("#cpyEnd").value);
    if(!(f&&s&&e) || s>e){ msg("Enter valid years"); return; }
    $("#yearRangeModal").style.display="none";
    copyYearToRange(f,s,e);
  });

  // Data
  $("#btnBackup").addEventListener("click", backupJSON);
  $("#btnRestore").addEventListener("click", ()=>$("#fileRestore").click());
  $("#fileRestore").addEventListener("change", e=>{
    const file=e.target.files?.[0];
    if(file) restoreJSON(file);
    e.target.value="";
  });

  // Share & Print
  $("#btnPrintMonth").addEventListener("click", ()=>window.print());
  $("#btnExportHtml").addEventListener("click", exportMonthHTML);
  $("#btnExportCSV").addEventListener("click", exportCSV);
  $("#btnImportCSV").addEventListener("click", ()=>$("#fileImport").click());
  $("#fileImport").addEventListener("change", e=>{
    if(e.target.files?.[0]) importCSVFile(e.target.files[0]);
    e.target.value="";
  });

  // Repeat
  $("#btnApplyRepeat").addEventListener("click", applyRepeat);

  // Filters
  $("#fltAll").addEventListener("click", ()=>setFilter("all"));
  $("#fltRun").addEventListener("click", ()=>setFilter("run"));
  $("#fltPreventive").addEventListener("click", ()=>setFilter("preventive"));
  $("#btnApplyCustom").addEventListener("click", ()=>{
    const kind=$("#customFilterKind").value;
    const val =$("#customFilterVal").value||"";
    setFilter(kind, val);
  });

  // Cleanup (YES/NO)
  const openConfirm=(title,msg, onYes)=>{
    $("#confirmTitle").textContent=title;
    $("#confirmMsg").textContent=msg;
    $("#confirmModal").style.display="flex";
    const yes=$("#cnfYes"), no=$("#cnfNo");
    const close=()=>$("#confirmModal").style.display="none";
    const cleanup=()=>{
      yes.removeEventListener("click",yesHandler);
      no.removeEventListener("click",noHandler);
      close();
    };
    const yesHandler=()=>{ onYes(); cleanup(); };
    const noHandler =()=>cleanup();
    yes.addEventListener("click", yesHandler);
    no.addEventListener("click", noHandler);
  };

  $("#btnClearMonth").addEventListener("click", ()=>{
    const y = Number($("#yearSel").value), m = Number($("#monthSel").value);
    openConfirm("Clear This Month","Are you sure you want to clear all placements for this month?", ()=>{
      state.months[keyFor(y,m)] = {};
      save();
      renderCurrent();
    });
  });

  $("#btnResetAll").addEventListener("click", ()=>{
    openConfirm("Reset Everything","This wipes all months & tasks. Are you sure?", ()=>{
      state.months = {};
      state.palette = [];
      save();
      renderCurrent();
      refreshPalette();
    });
  });
}

function boot(){
  buildSelectors();
  refreshPalette();
  bindButtons();
  renderMonth(); // default view
  renderTable(); // prebuild table content
}
document.addEventListener("DOMContentLoaded", boot);
